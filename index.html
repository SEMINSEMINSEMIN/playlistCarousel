<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="style.css">
    <title>플레이 리스트</title>
</head>
<body>
    <article id="app">
        <h2 class="text-hidden">플레이 리스트</h2>
        <ul class="list-item">
            <li><div id="player0"></div></li>
            <li><div id="player1"></div></li>
            <li><div id="player2"></div></li>
            <li><div id="player3"></div></li>
            <li><div id="player4"></div></li>
            <li><div id="player5"></div></li>
            <li><div id="player6"></div></li>
        </ul>
    </article>
    <script>
        // API 불러오기
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
        // 휠 변수
        const center = document.querySelector('.list-item');
        const items = center.querySelectorAll('li');
        const angle = 360 / items.length;
        let currAngle = 0;
        function turnLocation(currAngle, nowCurrAngle){
            center.animate([
                {transform: `translate(-50%, -50%) rotateY(${nowCurrAngle}deg)`},
                {transform: `translate(-50%, -50%) rotateY(${currAngle}deg)`}
            ], {duration: 1000, easing: "ease"});
            center.style.transform = `translate(-50%, -50%) rotateY(${currAngle}deg)`;
        }
    
        // 비디오 데이터
        function Players(playerName, videoId, $startSeconds, $endSeconds){
            this.playerName = playerName;
            this.$videoId = videoId;
            this.$startSeconds = $startSeconds;
            this.$endSeconds = $endSeconds;
        }
    
        const videoInfoData = [
            new Players('player0', 'Aq_gsctWHtQ', 55, 86),
            new Players('player1', 'PfpERIQXIrk', 74, 103),
            new Players('player2', 'vFuU4rIZZ30', 44, 61),
            new Players('player3', 'zC8RrOA0spo', 65, 104),
            new Players('player4', 'hoknJbAsOZY', 65, 88),
            new Players('player5', 'ty8fr7vmedg', 72, 101),
            new Players('player6', 'DJ4Zda11iSo', 52, 100)
        ];
    
        // 비디오 삽입
        const playerList = [];
    
        function onYouTubeIframeAPIReady(){
            for (let i = 0; i < videoInfoData.length; i++){
                const nowVideo = videoInfoData[i];
                let done = false;
                playerList.push(new YT.Player(nowVideo.playerName, {
                    videoId: nowVideo.$videoId,
                    width: '400',
                    height: '360',
                    playerVars: {'autoplay': 0},
                    events: {
                        'onStateChange': function onStateChange(event){
                            if (event.data == 1 && !done){
                                event.target.seekTo(nowVideo.$startSeconds);
                                const timeDiff = (nowVideo.$endSeconds - nowVideo.$startSeconds) * 1000;
    
                                function stopVideo(){
                                    event.target.stopVideo();
                                }
    
                                function afterMusicLocation(){
                                    const nowCurrAngle = currAngle;
                                    currAngle -= angle;
                                    center.animate([
                                        {transform: `translate(-50%, -50%) rotateY(${nowCurrAngle}deg)`},
                                        {transform: `translate(-50%, -50%) rotateY(${currAngle}deg)`}
                                    ], {duration: 1000, easing: "ease"});
                                    center.style.transform = `translate(-50%, -50%) rotateY(${currAngle}deg)`;
                                }
                                // 얘도 turnLocation 사용하고 싶은데 안 됨.. 이유를 모르겠음 ㅠ
                                // 그리고 일시중지하면 넘어가버리는 문제..
                                setTimeout(stopVideo, timeDiff);
                                setTimeout(afterMusicLocation, timeDiff + 1);

                                done = true;
                            
                            } else if (event.data == 0){
                                const nowCurrAngle = currAngle;
                                currAngle -= angle;
                                center.animate([
                                    {transform: `translate(-50%, -50%) rotateY(${nowCurrAngle}deg)`},
                                    {transform: `translate(-50%, -50%) rotateY(${currAngle}deg)`}
                                ], {duration: 1000, easing: "ease"});
                                center.style.transform = `translate(-50%, -50%) rotateY(${currAngle}deg)`;
                                event.target.stopVideo();
                            }
                        }
                    }
                }))
            }
            // 자동재생 문제
            const iframes = document.querySelectorAll('iframe');
            for (let iframe of iframes) {
                iframe.setAttribute('allow', "accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture");
            }
        }
    
        // 휠 돌아가게
        document.addEventListener('click', function(event){
            if (window.innerWidth / 2 < event.clientX){
                playerList.map(i => i.pauseVideo());
                const nowCurrAngle = currAngle;
                currAngle -= angle;
                turnLocation(currAngle, nowCurrAngle);
            } else {
                playerList.map(i => i.pauseVideo());
                const nowCurrAngle = currAngle;
                currAngle += angle;
                turnLocation(currAngle, nowCurrAngle);
            }
        })
    </script>
</body>
</html>